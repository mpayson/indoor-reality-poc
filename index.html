<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>Indoor Reality POC</title>

  <link rel="stylesheet" href="https://js.arcgis.com/4.4/esri/css/main.css">
  <script src="https://js.arcgis.com/4.4/"></script>
  <link rel="stylesheet" href="https://s3-us-west-1.amazonaws.com/patterns.esri.com/files/calcite-web/1.0.0-rc.6/css/calcite-web.min.css">
  <link rel="stylesheet" href="styles.css">

  <script type="text/javascript" src="layerconfig.js"></script>
  <script>
    require([
      "esri/views/SceneView",
      "esri/WebScene",
      "esri/tasks/support/Query",
      "esri/tasks/QueryTask",
      "esri/widgets/LayerList",
      "esri/widgets/Home",
      "esri/widgets/Expand",
      "dojo/dom-construct",
      "dojo/dom-class",
      "dojo/query",
      "dojo/on",
      "dojo/dom",
      "dojo/domReady!"
    ], function(
      SceneView, WebScene, Query, QueryTask, LayerList, Home, Expand, domConstruct, domClass, query, on, dom
    ) {

      var titleDiv = dom.byId("titleDiv");

      var scene = new WebScene({
        portalItem: { // autocasts as new PortalItem()
          id: "3eea1a96297e4287b958e934806d10d5"
        }
      });

      var view = new SceneView({
        map: scene,
        container: "viewDiv",
        viewingMode: "local",
        constraints: {
          collision: {
            enabled: false
          },
          tilt: {
            max: 179.99
          }
        }
      });

      function createSlideUI(slide, placement) {
        var slideElement = domConstruct.create("div", {
          id: slide.id,
          className: "slide"
        });
        var position = placement ? placement : "last";
        domConstruct.place(slideElement, "slidesDiv", position);
        domConstruct.create("div", {
          textContent: slide.title.text,
          className: "title font-size--1"
        }, slideElement);
        domConstruct.create("img", {
          src: slide.thumbnail.url,
          title: slide.title.text
        }, slideElement);
        on(slideElement, "click", function() {
          query(".slide").forEach(function(node) {
            domClass.remove(node, "active");
          });
          domClass.add(slideElement, "active");
          slide.applyTo(view);
        });
      }

      view.then(function() {
        var poseLyr = scene.layers.find(function(l) {
          return l.title === "Poses";
        });
        poseLyr.outFields = ["*"]

        dom.byId("optionsDiv").style.visibility = "visible"
        dom.byId("slidesDiv").style.visibility = "visible"
        const slides = scene.presentation.slides
        slides.forEach(createSlideUI)

        view.whenLayerView(poseLyr)
          .then(function(poseLyrView) {
            view.on("double-click", function(event) {
              const screenPoint = {
                x: event.x,
                y: event.y
              }
              view.hitTest(screenPoint)
                .then(function(response) {
                  if(!response.results[0].graphic) return;
                  event.stopPropagation()
                  const atrs = response.results[0].graphic.attributes
                  const id = atrs.acquisitionId
                  const pose = atrs.poseId
                  const url = "http://esri.indoorreality.com/esri-viewer/" + id +"/" + pose
                  window.open(url, "_self")
                })
            })
          })
      })

      function getOpacity(scale, title, layerConfig){
        if(!layerConfig[title] || !layerConfig[title].opcRange){
          return null
        }
        const range = layerConfig[title].opcRange
        const opc = (scale - range[1])/(range[0] - range[1])
        return Math.min(Math.max(opc, 0), 1)
      }
      var scaleVisSet = new Set()
      var viewHandle = view.watch("scale", (newVal) => {
        scene.layers.forEach((lyr) => {
          const title = lyr.title
          const opc = getOpacity(view.scale, title, layerConfig)
          if(opc === null) return;
          if(opc < 0.01){
            lyr.visible = false
            lyr.listMode = "hide"
            scaleVisSet.add(title)
          }
          else{
            //only show if previously hidden by opacity value
            if(scaleVisSet.has(title)){
              lyr.visible = true
              lyr.listMode = "show"
              scaleVisSet.delete(title)
            }
            lyr.opacity = opc
          }
        })
      })

      function showFloors(evt) {
        var floorQuery = evt.target.value;
        scene.layers.forEach(function(lyr) {
          const config = layerConfig[lyr.title]
          if (config && config.hasFloorAtr) {
            lyr.definitionExpression = floorQuery;
          }
        });
      }
      on(dom.byId("floorSelect"), "change", showFloors);

      var activeExpand = null
      function setActiveExpand(nV, oV, expProp, expObj){
        if(nV === true && expObj !== activeExpand){
          activeExpand.expanded = false
          activeExpand = expObj
        }
      }

      var slideExpand = new Expand({
        view: view,
        content: dom.byId("slidesDiv"),
        expandIconClass: "esri-icon-media",
        expanded: true
      })
      activeExpand = slideExpand
      var layerList = new LayerList({
        view: view,
        container: document.createElement("div")
      });
      var listExpand = new Expand({
        view: view,
        content: layerList.container,
        expandIconClass: "esri-icon-layer-list"
      });
      var filterExpand = new Expand({
        view: view,
        content: dom.byId("optionsDiv"),
        expandIconClass: "esri-icon-filter"
      });
      
      [slideExpand, listExpand, filterExpand].forEach((exp) =>
        exp.watch("expanded", setActiveExpand)
      )

      var homeBtn = new Home({
        view: view
      });

      view.ui.add([slideExpand, listExpand, filterExpand, homeBtn], "top-right");
    });
  </script>
</head>

<body>
  <div id="viewDiv"></div>
  <div id="optionsDiv">
    <div><b>Filter Interior Floor:</b>
      <select id="floorSelect">
        <option value="1=1">All</option>
        <option value="Floor = -1">-1</option>
        <option value="Floor = 1">1</option>
        <option value="Floor = 2">2</option>
        <option value="Floor = 3">3</option>
        <option value="Floor = 4">4</option>
        <option value="Floor = 5">5</option>
      </select>
    </div>
  </div>
  <div id="slidesDiv"></div>
</body>

</html>